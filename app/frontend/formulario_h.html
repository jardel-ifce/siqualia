<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<title>Formulário H - Determinação de PCC</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
	<h2 class="mb-4">Determinação de PCC (Formulário H)</h2>
	
	<div class="mb-4">
		<label class="form-label" for="produto">Selecione o Produto:</label>
		<select class="form-select" id="produto" onchange="carregarTabela()">
			<option value="">Carregando produtos...</option>
		</select>
	</div>
	
	<table class="table table-bordered table-striped" id="tabelaFormularios" style="display:none;">
		<thead class="table-dark">
		<tr>
			<th>#ID</th>
			<th>Etapa</th>
			<th>Tipo de Perigo</th>
			<th>Perigo</th>
			<th>Significativo?</th>
			<th>Ação</th>
		</tr>
		</thead>
		<tbody></tbody>
	</table>
	
	<div class="text-danger mt-3" id="mensagem"></div>
</div>

<!-- Modal -->
<div aria-hidden="true" aria-labelledby="modalLabel" class="modal fade" id="modalQuestionario" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content p-4">
			<div class="modal-header">
				<h5 class="modal-title">Formulário H - Questionário</h5>
				<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
			</div>
			<div class="modal-body">
				<div id="perguntaContainer" style="display:none;">
					<p class="fw-bold" id="textoPergunta"></p>
					<div class="d-flex flex-column gap-2" id="opcoesContainer"></div>
				</div>
				<div class="alert alert-info fw-bold" id="resultadoFinal" style="display:none;"></div>
				<div class="text-danger mt-3" id="erroModal"></div>
			</div>
		</div>
	</div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
	let idFormularioGAtual = null;
	let modal;
	let codigoPerguntaAtual = "q1";
	
	async function carregarProdutos() {
		const select = document.getElementById("produto");
		try {
			const res = await fetch("http://127.0.0.1:8000/produtos");
			const data = await res.json();
			select.innerHTML = '<option value="">Selecione um produto</option>';
			data.forEach(p => {
				const opt = document.createElement("option");
				opt.value = p.nome_produto;
				opt.textContent = p.nome_produto;
				select.appendChild(opt);
			});
		} catch (err) {
			select.innerHTML = '<option>Erro ao carregar produtos</option>';
			console.error(err);
		}
	}
	
	async function carregarTabela() {
		const produto = document.getElementById("produto").value;
		const tabela = document.getElementById("tabelaFormularios");
		const corpo = tabela.querySelector("tbody");
		const msg = document.getElementById("mensagem");
		
		if (!produto) {
			tabela.style.display = "none";
			msg.textContent = "Selecione um produto para visualizar os registros.";
			return;
		}
		
		try {
			const res = await fetch(`http://127.0.0.1:8000/formulario-g/tabela?produto=${encodeURIComponent(produto)}`);
			const data = await res.json();
			
			corpo.innerHTML = "";
			data.forEach(linha => {
				let statusH = linha.pcc;
				let btnPreencher = `<button class="btn btn-sm btn-primary" onclick="abrirModal(${linha.id_formulario_g})" title="Preencher Formulário H"><i class="bi bi-card-checklist"></i></button>`;
				let btnRelatorio = `
					<span title="Relatório não disponível">
						<button class="btn btn-sm btn-secondary" title="Relatório não disponível" disabled><i class="bi bi-file-earmark-text-fill"></i></button>
					</span>
				`;
				
				if (statusH) {
					btnPreencher = `
						<span title="Formulário H Preenchido">
							<button class="btn btn-sm btn-secondary" disabled><i class="bi bi-card-checklist"></i></button>
						</span>
						`;
					const ativo = statusH === "É um PCC";
					btnRelatorio = `
					  <span title="${ativo ? 'Visualizar relatório' : 'Relatório não disponível'}">
					    <button class="btn btn-sm btn-${ativo ? 'success' : 'secondary'}" ${ativo ? '' : 'disabled'}>
					      <i class="bi bi-file-earmark-text-fill"></i>
					    </button>
					  </span>
					`;
				}
				
				const tr = document.createElement("tr");
				tr.innerHTML = `
            <td>${linha.id_formulario_g}</td>
            <td>${linha.nome_etapa}</td>
            <td>${linha.codigo_perigo}</td>
            <td>${linha.descricao_perigo}</td>
            <td>${linha.perigo_significativo || '-'}</td>
            <td>
			    ${btnPreencher}
			    ${btnRelatorio}
			</td>
          `;
				corpo.appendChild(tr);
			});
			
			tabela.style.display = "table";
			msg.textContent = data.length === 0 ? "Nenhum formulário G encontrado para este produto." : "";
			
		} catch (err) {
			console.error(err);
			msg.textContent = "Erro ao buscar registros.";
			tabela.style.display = "none";
		}
	}
	
	function abrirModal(idG) {
		idFormularioGAtual = idG;
		respostasH = {
			q1_medidas_preventivas: null,
			controlado_por_prerequisito: null,
			q2_reducao_perigo: null,
			q3_aumento_perigo: null,
			q4_eliminacao_posterior: null
		};
		
		codigoPerguntaAtual = "q1";
		modal = new bootstrap.Modal(document.getElementById("modalQuestionario"));
		modal.show();
		carregarPergunta("q1");
	}
	
	
	async function carregarPergunta(codigo) {
		try {
			const res = await fetch(`http://127.0.0.1:8000/formulario-h/questionario/${codigo}`);
			const data = await res.json();
			
			document.getElementById("textoPergunta").textContent = data.texto_pergunta;
			const container = document.getElementById("opcoesContainer");
			container.innerHTML = "";
			
			data.opcoes.forEach(op => {
				const btn = document.createElement("button");
				btn.className = "btn btn-outline-primary";
				btn.textContent = op.texto_opcao;
				btn.onclick = () => responder(op);
				container.appendChild(btn);
			});
			
			document.getElementById("perguntaContainer").style.display = "block";
			document.getElementById("resultadoFinal").style.display = "none";
			document.getElementById("erroModal").textContent = "";
			
		} catch (err) {
			console.error(err);
			document.getElementById("erroModal").textContent = "Erro ao carregar pergunta.";
		}
	}
	
	let respostasH = {
		q1_medidas_preventivas: null,
		controlado_por_prerequisito: null,
		q2_reducao_perigo: null,
		q3_aumento_perigo: null,
		q4_eliminacao_posterior: null
	};
	
	function responder(opcao) {
		const pergunta = codigoPerguntaAtual;
		
		// Armazena as respostas intermediárias
		switch (pergunta) {
			case "q1":
				respostasH.q1_medidas_preventivas = opcao.texto_opcao;
				break;
			case "q1a":
				respostasH.controlado_por_prerequisito = opcao.texto_opcao;
				break;
			case "q2":
				respostasH.q2_reducao_perigo = opcao.texto_opcao;
				break;
			case "q3":
				respostasH.q3_aumento_perigo = opcao.texto_opcao;
				break;
			case "q4":
				respostasH.q4_eliminacao_posterior = opcao.texto_opcao;
				break;
		}
		
		// Finaliza
		if (opcao.resultado_final) {
			document.getElementById("perguntaContainer").style.display = "none";
			document.getElementById("resultadoFinal").innerText = `Resultado: ${opcao.resultado_final}`;
			document.getElementById("resultadoFinal").style.display = "block";
			
			const payload = {
				id_formulario_g: idFormularioGAtual,
				...respostasH,
				pcc: opcao.resultado_final
			};
			
			fetch("http://127.0.0.1:8000/formulario-h/responder", {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify(payload)
			})
					.then(res => res.json())
					.then(data => {
						console.log("✅ Formulário H salvo:", data.message);
					})
					.catch(err => {
						console.error("Erro ao salvar formulário H:", err);
					});
		} else if (opcao.proxima_codigo) {
			codigoPerguntaAtual = opcao.proxima_codigo;
			carregarPergunta(opcao.proxima_codigo);
		}
	}
	
	carregarProdutos();
</script>
</body>
</html>
