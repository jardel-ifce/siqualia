<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<title>Plano Resumo APPCC</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
	<h2 class="mb-4">Plano Resumo do Sistema APPCC</h2>
	
	<div class="mb-4">
		<label class="form-label" for="produto">Selecione o Produto:</label>
		<select class="form-select" id="produto" onchange="carregarPlanoResumo()">
			<option value="">Carregando produtos...</option>
		</select>
	</div>
	
	<div id="resultado" style="display:none;">
		<table class="table table-bordered table-striped" id="tabelaResumo">
			<thead class="table-dark">
			<tr>
				<th>Etapa</th>
				<th>PCC</th>
				<th>Perigo</th>
				<th>Medidas Preventivas</th>
				<th>Limite Crítico</th>
				<th>Monitoramento</th>
				<th>Ação Corretiva</th>
				<th>Ações</th>
			</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
	
	<div class="text-danger mt-3" id="mensagem"></div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="modalEditarPCC" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header">
        <h5 class="modal-title">Complementar Plano de Monitoramento do PCC</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarPCC">
          <div class="mb-3">
            <label for="limiteCritico" class="form-label">Limite Crítico</label>
            <input type="text" class="form-control" id="limiteCritico">
          </div>
          <div class="mb-3">
            <label for="monitoramento" class="form-label">Monitoramento</label>
            <textarea class="form-control" id="monitoramento" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="acaoCorretiva" class="form-label">Ação Corretiva</label>
            <textarea class="form-control" id="acaoCorretiva" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="registros" class="form-label">Registros</label>
            <textarea class="form-control" id="registros" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="verificacao" class="form-label">Verificação</label>
            <textarea class="form-control" id="verificacao" rows="2"></textarea>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-success" onclick="salvarEdicao()">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
	async function carregarProdutos() {
		const select = document.getElementById("produto");
		try {
			const res = await fetch("http://127.0.0.1:8000/produtos");
			const data = await res.json();
			select.innerHTML = '<option value="">Selecione um produto</option>';
			data.forEach(p => {
				const opt = document.createElement("option");
				opt.value = p.nome_produto;
				opt.textContent = p.nome_produto;
				select.appendChild(opt);
			});
		} catch (err) {
			select.innerHTML = '<option>Erro ao carregar produtos</option>';
			console.error(err);
		}
	}
	
	async function carregarPlanoResumo() {
		const produto = document.getElementById("produto").value;
		const tabela = document.getElementById("tabelaResumo").querySelector("tbody");
		const msg = document.getElementById("mensagem");
		
		if (!produto) {
			document.getElementById("resultado").style.display = "none";
			msg.textContent = "Selecione um produto para visualizar o plano.";
			return;
		}
		
		try {
			const res = await fetch(`http://127.0.0.1:8000/plano-resumo/${encodeURIComponent(produto)}`);
			const data = await res.json();
			
			tabela.innerHTML = "";
			data.forEach((item, index) => {
				const tr = document.createElement("tr");
				tr.innerHTML = `
				    <td>${item.etapa}</td>
				    <td>${item.pcc_codigo}</td>
				    <td>${item.perigo}</td>
				    <td>${item.medidas}</td>
				    <td contenteditable="true" id="lc-${index}">${item.limite_critico || ""}</td>
				    <td contenteditable="true" id="mon-${index}">${item.monitoramento || ""}</td>
				    <td contenteditable="true" id="ac-${index}">${item.acao_corretiva || ""}</td>
				    <td class="d-flex gap-2">
					    <button class="btn btn-primary btn-sm" title="Editar" onclick="editarPCC(${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
					      <i class="bi bi-pencil-square"></i>
					    </button>
					    <button class="btn btn-info btn-sm" title="Imprimir Relatório" onclick="imprimirPCC(${index})">
					      <i class="bi bi-printer"></i>
					    </button>
					  </td>
				  `;
				tabela.appendChild(tr);
			});
			
			
			document.getElementById("resultado").style.display = "block";
			msg.textContent = data.length === 0 ? "Nenhum PCC encontrado para este produto." : "";
			
		} catch (err) {
			console.error(err);
			msg.textContent = "Erro ao carregar o plano resumo.";
			document.getElementById("resultado").style.display = "none";
		}
	}
	
	let indexAtual = null;
	let itemAtual = null;
	let modal = new bootstrap.Modal(document.getElementById("modalEditarPCC"));
	
	function editarPCC(index, item) {
	  indexAtual = index;
	  itemAtual = item;
	
	  // Preenche o modal com os valores atuais da tabela (se já editados)
	  document.getElementById("limiteCritico").value = document.getElementById(`lc-${index}`).innerText.trim();
	  document.getElementById("monitoramento").value = document.getElementById(`mon-${index}`).innerText.trim();
	  document.getElementById("acaoCorretiva").value = document.getElementById(`ac-${index}`).innerText.trim();
	  document.getElementById("registros").value = document.getElementById(`reg-${index}`)?.innerText.trim() || "";
	  document.getElementById("verificacao").value = document.getElementById(`ver-${index}`)?.innerText.trim() || "";
	
	  modal.show();
	}
	
	function salvarEdicao() {
	  document.getElementById(`lc-${indexAtual}`).innerText = document.getElementById("limiteCritico").value.trim();
	  document.getElementById(`mon-${indexAtual}`).innerText = document.getElementById("monitoramento").value.trim();
	  document.getElementById(`ac-${indexAtual}`).innerText = document.getElementById("acaoCorretiva").value.trim();
	  document.getElementById(`reg-${indexAtual}`).innerText = document.getElementById("registros").value.trim();
	  document.getElementById(`ver-${indexAtual}`).innerText = document.getElementById("verificacao").value.trim();
	  modal.hide();
	}
	
	function imprimirPCC(index) {
		const row = document.querySelectorAll("#tabelaResumo tbody tr")[index];
		const clone = row.cloneNode(true);
		const tempDiv = document.createElement("div");
		tempDiv.innerHTML = `
		    <h4>Plano de Monitoramento - PCC</h4>
		    <table class="table table-bordered">${clone.outerHTML}</table>
		  `;
		
		html2pdf().from(tempDiv).set({
			margin: 0.5,
			filename: `pcc_${index + 1}.pdf`,
			html2canvas: {scale: 2},
			jsPDF: {orientation: "landscape"}
		}).save();
	}

	carregarProdutos();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
